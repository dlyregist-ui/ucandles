import React, { useMemo, useState, useEffect } from "react";

/***************************
 * Minimal UI kit (+ tiny icons)
 ***************************/
const Card: React.FC<React.PropsWithChildren<{ style?: React.CSSProperties }>> = ({ children, style }) => (
  <div
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 16,
      padding: 16,
      boxShadow: "0 1px 2px rgba(0,0,0,0.04)",
      background: "#fff",
      ...style,
    }}
  >
    {children}
  </div>
);
const CardHeader: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ marginBottom: 8 }}>{children}</div>
);
const CardTitle: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <h3
    style={{
      display: "flex",
      alignItems: "center",
      justifyContent: "space-between",
      margin: 0,
      fontSize: 16,
      fontWeight: 600,
    }}
  >
    {children}
  </h3>
);
const CardContent: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ display: "grid", gap: 10 }}>{children}</div>
);
const Button: React.FC<
  React.PropsWithChildren<{
    onClick?: () => void;
    disabled?: boolean;
    full?: boolean;
    variant?: "primary" | "ghost";
  }>
> = ({ children, onClick, disabled, full, variant = "primary" }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    style={{
      width: full ? "100%" : undefined,
      padding: "10px 14px",
      borderRadius: 12,
      border: variant === "ghost" ? "1px solid transparent" : "1px solid #111",
      background: disabled ? "#f3f4f6" : variant === "ghost" ? "transparent" : "#111",
      color: disabled ? "#9ca3af" : variant === "ghost" ? "#111" : "#fff",
      cursor: disabled ? "not-allowed" : "pointer",
      fontWeight: 600,
    }}
  >
    {children}
  </button>
);
const Badge: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <span
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 999,
      padding: "4px 10px",
      fontSize: 12,
      color: "#374151",
      background: "#f9fafb",
    }}
  >
    {children}
  </span>
);

/***************************
 * Modal
 ***************************/
const Modal: React.FC<{ open: boolean; onClose: () => void; title?: string; image?: string }> = ({
  open,
  onClose,
  title,
  image,
  children,
}) => {
  if (!open) return null;
  return (
    <div
      role="dialog"
      aria-modal="true"
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.45)",
        display: "grid",
        placeItems: "center",
        zIndex: 50,
      }}
      onClick={onClose}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        style={{
          width: "min(900px, 92vw)",
          maxHeight: "90vh",
          overflow: "auto",
          background: "#fff",
          borderRadius: 16,
          boxShadow: "0 10px 30px rgba(0,0,0,.2)",
        }}
      >
        <div
          style={{
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            padding: "14px 18px",
            borderBottom: "1px solid #e5e7eb",
          }}
        >
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 700 }}>{title}</h3>
          <button
            onClick={onClose}
            aria-label="Закрыть"
            style={{
              background: "transparent",
              border: "none",
              fontSize: 22,
              lineHeight: 1,
              cursor: "pointer",
            }}
          >
            ×
          </button>
        </div>
        <div style={{ display: "grid", gap: 16, padding: 18 }}>
          {image ? (
            <img
              src={image}
              alt={title || ""}
              style={{ width: "100%", maxHeight: 360, objectFit: "cover", borderRadius: 12 }}
              onError={(e) => {
                (e.currentTarget as HTMLImageElement).style.display = "none";
              }}
            />
          ) : (
            <div
              style={{
                height: 220,
                background: "#f3f4f6",
                borderRadius: 12,
                display: "grid",
                placeItems: "center",
                color: "#9ca3af",
              }}
            >
              Нет фото
            </div>
          )}
          {children}
        </div>
      </div>
    </div>
  );
};

/***************************
 * Icons
 ***************************/
const IconBox = () => (
  <svg
    width="16"
    height="16"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
  >
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
    <polyline points="3.29 7 12 12 20.71 7" />
  </svg>
);
const IconCart = () => (
  <svg
    width="16"
    height="16"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
  >
    <circle cx="9" cy="21" r="1" />
    <circle cx="20" cy="21" r="1" />
    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
  </svg>
);

/***************************
 * Types
 ***************************/
 type ProductType =
  | "свеча"
  | "диффузор"
  | "рефил"
  | "молочко"
  | "мыло"
  | "скраб"
  | "автопарфюм"
  | "лосьон"
  | "бомбочка";
interface Aroma {
  name: string;
  image?: string;
  description?: string;
  pyramid?: { top?: string[]; heart?: string[]; base?: string[] };
}
interface BoxTemplate {
  id: string;
  slots: ProductType[];
  title?: string;
}
interface GiftBox {
  id: string;
  name: string;
  basePrice: number;
  fixedSetPrice?: number;
  image?: string;
  templates: BoxTemplate[];
}

/***************************
 * Data
 ***************************/
const BOXES: GiftBox[] = [
  {
    id: "small",
    name: "Набор малый",
    basePrice: 0,
    fixedSetPrice: 2000,
    image: "/images/179A9273.jpg",
    templates: [
      {
        id: "S-fixed",
        title: "Диффузор 1шт + Свеча 1шт + Автопарфюм 1шт",
        slots: ["диффузор", "свеча", "автопарфюм"],
      },
    ],
  },
  {
    id: "medium",
    name: "Набор средний",
    basePrice: 0,
    fixedSetPrice: 3500,
    image: "/images/179A9301.jpg",
    templates: [
      {
        id: "M-fixed",
        title:
          "Диффузор 1 + Мыло 1 + Лосьон 1 + Свеча 2 + Скраб 1 + Бомбочка 1 + Автопарфюм 1",
        slots: [
          "диффузор",
          "мыло",
          "лосьон",
          "свеча",
          "свеча",
          "скраб",
          "бомбочка",
          "автопарфюм",
        ],
      },
    ],
  },
  {
    id: "large",
    name: "Набор большой",
    basePrice: 0,
    fixedSetPrice: 5000,
    image: "/images/179A9329.jpg",
    templates: [
      {
        id: "L-fixed",
        title: "Диффузор 2 + Мыло 1 + Лосьон 1 + Свеча 3 + Скраб 2 + Бомбочка 3",
        slots: [
          "диффузор",
          "диффузор",
          "мыло",
          "лосьон",
          "свеча",
          "свеча",
          "свеча",
          "скраб",
          "скраб",
          "бомбочка",
          "бомбочка",
          "бомбочка",
        ],
      },
    ],
  },
];

const AROMAS: Record<ProductType, Aroma[]> = {
  диффузор: [
    {
      name: "Arabian Nights",
      description: "Загадочный и тёплый аромат востока.",
      pyramid: {
        top: ["Бергамот", "Лимон", "Шафран"],
        heart: ["Роза", "Уд"],
        base: ["Сандал", "Мускус", "Пачули"],
      },
    },
    { name: "Astoria Lux" },
    { name: "Basil & Mint" },
    { name: "Black Currant" },
    { name: "Black Pepper" },
  ],
  свеча: [
    {
      name: "Arabian Nights",
      description: "Свеча Arabian Nights — загадочный и тёплый аромат востока.",
      pyramid: {
        top: ["Бергамот", "Лимон", "Шафран"],
        heart: ["Роза", "Уд"],
        base: ["Сандал", "Мускус", "Пачули"],
      },
    },
    { name: "Mango Kiss" },
    { name: "Smoked Vanilla" },
  ],
  автопарфюм: [{ name: "Basil & Mint" }, { name: "Royal Roses" }],
  рефил: [{ name: "Arabian Nights" }, { name: "Portofino Mandarino" }],
  молочко: [{ name: "Celtic Verbena" }],
  мыло: [{ name: "Celtic Verbena" }],
  лосьон: [{ name: "Celtic Verbena" }],
  скраб: [{ name: "Basil and Mint" }],
  бомбочка: [{ name: "Basil and Mint" }],
};

/***************************
 * Helpers
 ***************************/
const currency = (n: number) =>
  new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB" }).format(n);

/***************************
 * Component
 ***************************/
export default function GiftSetBuilder() {
  const [selectedBoxId, setSelectedBoxId] = useState<string | null>(null);
  const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
  const [slotSelections, setSlotSelections] = useState<{ aroma?: Aroma }[]>([]);
  const [detail, setDetail] = useState<{ type: ProductType; aroma: Aroma } | null>(
    null
  );
  const [viewAll, setViewAll] = useState<ProductType | null>(null);

  const selectedBox = useMemo(
    () => BOXES.find((b) => b.id === selectedBoxId) || null,
    [selectedBoxId]
  );
  const selectedTemplate = useMemo(
    () => selectedBox?.templates.find((t) => t.id === selectedTemplateId) || null,
    [selectedBox, selectedTemplateId]
  );

  useEffect(() => {
    if (selectedTemplate)
      setSlotSelections(selectedTemplate.slots.map(() => ({ aroma: undefined })));
  }, [selectedTemplateId, selectedTemplate]);

  const total = selectedBox?.fixedSetPrice ?? 0;
  const isComplete = useMemo(
    () => !!selectedTemplate && slotSelections.every((s) => s.aroma),
    [slotSelections, selectedTemplate]
  );

  const addAroma = (type: ProductType, aroma: Aroma) => {
    const idx = selectedTemplate!.slots.findIndex(
      (t, i) => t === type && !slotSelections[i]?.aroma
    );
    if (idx === -1) return;
    const next = [...slotSelections];
    next[idx] = { aroma };
    setSlotSelections(next);
  };
  const removeAromaByName = (type: ProductType, name: string) => {
    const idx = selectedTemplate!.slots.findIndex(
      (t, i) => t === type && slotSelections[i]?.aroma?.name === name
    );
    if (idx === -1) return;
    const next = [...slotSelections];
    next[idx] = { aroma: undefined };
    setSlotSelections(next);
  };

  return (
    <div style={{ maxWidth: 1040, margin: "0 auto", padding: 16 }}>
      {/* Шаг 1 — выбор коробки */}
      {!selectedBox && (
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(260px,1fr))",
            gap: 16,
          }}
        >
          {BOXES.map((box) => (
            <Card key={box.id}>
              <CardHeader>
                <CardTitle>
                  <span style={{ display: "inline-flex", alignItems: "center", gap: 8 }}>
                    <IconBox /> {box.name}
                  </span>
                  <Badge>{currency(box.fixedSetPrice ?? box.basePrice)}</Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <Button
                  full
                  onClick={() => {
                    setSelectedBoxId(box.id);
                    setSelectedTemplateId(box.templates[0].id);
                  }}
                >
                  Выбрать
                </Button>
                <div
                  style={{
                    fontSize: 12,
                    color: "#6b7280",
                    marginTop: 8,
                    whiteSpace: "pre-line",
                  }}
                >
                  {box.templates[0].title
                    ?.split("+")
                    .map((line, i) => (
                      <div key={i} style={{ marginBottom: 2 }}>
                        {line.trim()}
                      </div>
                    ))}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Шаг 2 — карусели по типам */}
      {selectedBox && selectedTemplate && (
        <div style={{ marginTop: 24 }}>
          {Array.from(new Set(selectedTemplate.slots)).map((type) => {
            const need = selectedTemplate.slots.filter((t) => t === type).length;
            const selected = slotSelections.filter(
              (s, i) => selectedTemplate.slots[i] === type && s.aroma
            ).length;
            const list = AROMAS[type as ProductType] || [];
            return (
              <div key={type} style={{ marginBottom: 24 }}>
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    marginBottom: 10,
                    flexWrap: "wrap",
                    gap: 8,
                  }}
                >
                  <div
                    style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}
                  >
                    <h2 style={{ margin: 0, fontSize: 18, fontWeight: 700 }}>
                      Выберите: {type}
                    </h2>
                    <span style={{ fontSize: 12, color: selected === need ? "green" : "#6b7280" }}>
                      (нужно {need}, выбрано {selected})
                    </span>
                    <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                      {selectedTemplate.slots.map((t, i) =>
                        t === type && slotSelections[i]?.aroma ? (
                          <span
                            key={`${type}-sel-${i}`}
                            style={{
                              display: "inline-flex",
                              alignItems: "center",
                              gap: 6,
                              padding: "4px 8px",
                              background: "#eef2ff",
                              borderRadius: 999,
                              fontSize: 12,
                            }}
                          >
                            {slotSelections[i]!.aroma!.name}
                            <button
                              onClick={() =>
                                removeAromaByName(
                                  type as ProductType,
                                  slotSelections[i]!.aroma!.name
                                )
                              }
                              style={{ border: "none", background: "transparent", cursor: "pointer" }}
                            >
                              ×
                            </button>
                          </span>
                        ) : null
                      )}
                    </div>
                  </div>
                  <Button variant="ghost" onClick={() => setViewAll(type as ProductType)}>
                    Посмотреть все
                  </Button>
                </div>
                <div style={{ display: "flex", overflowX: "auto", gap: 12, paddingBottom: 8 }}>
                  {list.map((ar, i) => (
                    <Card key={ar.name + "-" + i} style={{ minWidth: 220, flex: "0 0 auto" }}>
                      <CardContent>
                        <div
                          style={{
                            height: 160,
                            background: "#f3f4f6",
                            borderRadius: 12,
                            display: "grid",
                            placeItems: "center",
                            color: "#9ca3af",
                          }}
                        >
                          Нет фото
                        </div>
                        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                          <div style={{ fontWeight: 700 }}>{ar.name}</div>
                          <Badge>{type}</Badge>
                        </div>
                        <div style={{ display: "flex", gap: 6 }}>
                          <Button variant="ghost" onClick={() => setDetail({ type: type as ProductType, aroma: ar })}>
                            Подробнее
                          </Button>
                          <Button onClick={() => addAroma(type as ProductType, ar)} disabled={selected >= need}>
                            Выбрать
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Шаг 3 — итог */}
      {selectedBox && (
        <div style={{ marginTop: 24 }}>
          <Card>
            <CardHeader>
              <CardTitle>Стоимость набора</CardTitle>
            </CardHeader>
            <CardContent>
              <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 12 }}>{currency(total)}</div>
              {selectedTemplate && (
                <div style={{ marginBottom: 12 }}>
                  <div style={{ fontWeight: 600, marginBottom: 6 }}>Вы выбрали:</div>
                  <ul style={{ margin: 0, paddingLeft: 18 }}>
                    {selectedTemplate.slots.map((t, i) => (
                      <li key={i} style={{ fontSize: 14, lineHeight: 1.6 }}>
                        {t}: {slotSelections[i]?.aroma?.name || "— не выбрано"}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
              <div>
                <Button full disabled={!isComplete}>
                  <span style={{ display: "inline-flex", alignItems: "center", gap: 8 }}>
                    <IconCart /> Добавить в корзину
                  </span>
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Aroma details modal */}
      <Modal
        open={!!detail}
        onClose={() => setDetail(null)}
        title={detail ? `${detail.type}: ${detail.aroma.name}` : ""}
        image={detail?.aroma.image}
      >
        {detail ? (
          <div style={{ display: "grid", gap: 16 }}>
            <div style={{ fontSize: 14, lineHeight: 1.6, color: "#374151" }}>
              {detail.aroma.description || (
                <>
                  <div>
                    <b>{detail.aroma.name}</b> — описание будет добавлено позднее. Расскажем о характере
                    аромата, эффектах и форме выпуска.
                  </div>
                </>
              )}
            </div>
            <div style={{ background: "#f9fafb", border: "1px solid #e5e7eb", borderRadius: 12, padding: 14 }}>
              <h4 style={{ margin: "0 0 8px 0" }}>Пирамида аромата</h4>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 14 }}>
                <tbody>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>Верхние ноты</td>
                    <td style={{ padding: "4px 8px" }}>{(detail.aroma.pyramid?.top || []).join(", ") || "—"}</td>
                  </tr>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>Сердце</td>
                    <td style={{ padding: "4px 8px" }}>{(detail.aroma.pyramid?.heart || []).join(", ") || "—"}</td>
                  </tr>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>База</td>
                    <td style={{ padding: "4px 8px" }}>{(detail.aroma.pyramid?.base || []).join(", ") || "—"}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        ) : null}
      </Modal>

      {/* View all modal */}
      <Modal open={!!viewAll} onClose={() => setViewAll(null)} title={viewAll ? `Все ароматы: ${viewAll}` : ""}>
        {viewAll ? (
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(220px,1fr))", gap: 12 }}>
            {(AROMAS[viewAll] || []).map((ar, i) => (
              <Card key={`${viewAll}-${ar.name}-${i}`}>
                <CardContent>
                  <div
                    style={{
                      height: 140,
                      background: "#f3f4f6",
                      borderRadius: 12,
                      display: "grid",
                      placeItems: "center",
                      color: "#9ca3af",
                    }}
                  >
                    Нет фото
                  </div>
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                    <div style={{ fontWeight: 700 }}>{ar.name}</div>
                    <Badge>{viewAll}</Badge>
                  </div>
                  <div style={{ display: "flex", gap: 6 }}>
                    <Button variant="ghost" onClick={() => setDetail({ type: viewAll!, aroma: ar })}>
                      Подробнее
                    </Button>
                    <Button
                      onClick={() => {
                        addAroma(viewAll!, ar);
                      }}
                    >
                      Выбрать
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        ) : null}
      </Modal>
    </div>
  );
}
