import React, { useMemo, useState, useEffect } from "react";

/***************************
 * Minimal UI kit (+ tiny icons)
 ***************************/
const Card: React.FC<React.PropsWithChildren<{ style?: React.CSSProperties; onClick?: () => void }>> = ({ children, style, onClick }) => (
  <div
    onClick={onClick}
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 16,
      padding: 16,
      boxShadow: "0 1px 2px rgba(0,0,0,0.04)",
      background: "#fff",
      position: "relative",
      cursor: onClick ? "pointer" : "default",
      transition: "all 0.3s ease",
      overflow: "hidden",
      ...style,
    }}
    onMouseEnter={(e) => {
      const overlay = e.currentTarget.querySelector(".overlay") as HTMLElement;
      if (overlay) overlay.style.opacity = "1";
    }}
    onMouseLeave={(e) => {
      const overlay = e.currentTarget.querySelector(".overlay") as HTMLElement;
      if (overlay) overlay.style.opacity = "0";
    }}
  >
    {children}
    <div
      className="overlay"
      style={{
        position: "absolute",
        inset: 0,
        background: "rgba(0,0,0,0.5)",
        color: "#fff",
        display: "grid",
        placeItems: "center",
        fontSize: 16,
        fontWeight: 600,
        opacity: 0,
        transition: "opacity 0.3s ease",
      }}
    >
      Подробнее
    </div>
  </div>
);
const CardHeader: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ marginBottom: 8 }}>{children}</div>
);
const CardTitle: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <h3
    style={{
      display: "flex",
      alignItems: "center",
      justifyContent: "space-between",
      margin: 0,
      fontSize: 16,
      fontWeight: 600,
    }}
  >
    {children}
  </h3>
);
const CardContent: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ display: "grid", gap: 10 }}>{children}</div>
);
const Button: React.FC<
  React.PropsWithChildren<{
    onClick?: () => void;
    disabled?: boolean;
    full?: boolean;
    variant?: "primary" | "ghost";
  }>
> = ({ children, onClick, disabled, full, variant = "primary" }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    style={{
      width: full ? "100%" : undefined,
      padding: "10px 14px",
      borderRadius: 12,
      border: variant === "ghost" ? "1px solid transparent" : "1px solid #111",
      background: disabled ? "#f3f4f6" : variant === "ghost" ? "transparent" : "#111",
      color: disabled ? "#9ca3af" : variant === "ghost" ? "#111" : "#fff",
      cursor: disabled ? "not-allowed" : "pointer",
      fontWeight: 600,
    }}
  >
    {children}
  </button>
);
const Badge: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <span
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 999,
      padding: "4px 10px",
      fontSize: 12,
      color: "#374151",
      background: "#f9fafb",
    }}
  >
    {children}
  </span>
);

/***************************
 * Modal
 ***************************/
const Modal: React.FC<{ open: boolean; onClose: () => void; title?: string; image?: string }> = ({
  open,
  onClose,
  title,
  image,
  children,
}) => {
  if (!open) return null;
  return (
    <div
      role="dialog"
      aria-modal="true"
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.45)",
        display: "grid",
        placeItems: "center",
        zIndex: 50,
      }}
      onClick={onClose}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        style={{
          width: "min(900px, 92vw)",
          maxHeight: "90vh",
          overflow: "auto",
          background: "#fff",
          borderRadius: 16,
          boxShadow: "0 10px 30px rgba(0,0,0,.2)",
        }}
      >
        <div
          style={{
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            padding: "14px 18px",
            borderBottom: "1px solid #e5e7eb",
          }}
        >
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 700 }}>{title}</h3>
          <button
            onClick={onClose}
            aria-label="Закрыть"
            style={{
              background: "transparent",
              border: "none",
              fontSize: 22,
              lineHeight: 1,
              cursor: "pointer",
            }}
          >
            ×
          </button>
        </div>
        <div style={{ display: "grid", gap: 16, padding: 18 }}>{children}</div>
      </div>
    </div>
  );
};

/***************************
 * Types
 ***************************/
type ProductType =
  | "свеча"
  | "диффузор"
  | "рефил"
  | "молочко"
  | "мыло"
  | "скраб"
  | "автопарфюм"
  | "лосьон"
  | "бомбочка";
interface Aroma {
  name: string;
  image?: string;
  description?: string;
  pyramid?: { top?: string[]; heart?: string[]; base?: string[] };
}
interface BoxTemplate {
  id: string;
  slots: ProductType[];
  title?: string;
}
interface GiftBox {
  id: string;
  name: string;
  basePrice: number;
  fixedSetPrice?: number;
  image?: string;
  templates: BoxTemplate[];
}

/***************************
 * Data
 ***************************/
const BOXES: GiftBox[] = [
  {
    id: "small",
    name: "Набор малый",
    basePrice: 0,
    fixedSetPrice: 2000,
    image: "/images/179A9273.jpg",
    templates: [
      {
        id: "S-fixed",
        title: "Диффузор 1шт + Свеча 1шт + Автопарфюм 1шт",
        slots: ["диффузор", "свеча", "автопарфюм"],
      },
    ],
  },
];

const AROMAS: Record<ProductType, Aroma[]> = {
  диффузор: [
    { name: "Arabian Nights", description: "Загадочный и тёплый аромат востока." },
    { name: "Astoria Lux" },
  ],
  свеча: [{ name: "Mango Kiss" }],
  автопарфюм: [{ name: "Basil & Mint" }],
  рефил: [],
  молочко: [],
  мыло: [],
  лосьон: [],
  скраб: [],
  бомбочка: [],
};

/***************************
 * Helpers
 ***************************/
const currency = (n: number) =>
  new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB" }).format(n);

/***************************
 * Component
 ***************************/
export default function GiftSetBuilder() {
  const [selectedBoxId, setSelectedBoxId] = useState<string | null>(null);
  const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
  const [slotSelections, setSlotSelections] = useState<{ aroma?: Aroma }[]>([]);
  const [detail, setDetail] = useState<{ type: ProductType; aroma: Aroma } | null>(null);

  const selectedBox = useMemo(() => BOXES.find((b) => b.id === selectedBoxId) || null, [selectedBoxId]);
  const selectedTemplate = useMemo(() => selectedBox?.templates.find((t) => t.id === selectedTemplateId) || null, [selectedBox, selectedTemplateId]);

  useEffect(() => {
    if (selectedTemplate) setSlotSelections(selectedTemplate.slots.map(() => ({ aroma: undefined })));
  }, [selectedTemplateId, selectedTemplate]);

  const total = selectedBox?.fixedSetPrice ?? 0;

  return (
    <div style={{ maxWidth: 1040, margin: "0 auto", padding: 16 }}>
      {!selectedBox && (
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(260px,1fr))", gap: 16 }}>
          {BOXES.map((box) => (
            <Card key={box.id}>
              <CardHeader>
                <CardTitle>
                  <span>{box.name}</span>
                  <Badge>{currency(box.fixedSetPrice ?? box.basePrice)}</Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div style={{ flex: 1 }} />
                <Button full onClick={() => { setSelectedBoxId(box.id); setSelectedTemplateId(box.templates[0].id); }}>Выбрать</Button>
                <div style={{ fontSize: 12, color: "#6b7280", marginTop: 8, whiteSpace: "pre-line" }}>
                  {box.templates[0].title?.split("+").map((line, i) => (
                    <div key={i}>{line.trim()}</div>
                  ))}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {selectedBox && selectedTemplate && (
        <div style={{ marginTop: 24 }}>
          {Array.from(new Set(selectedTemplate.slots)).map((type) => (
            <div key={type} style={{ marginBottom: 24 }}>
              <h2>Выберите: {type}</h2>
              <div style={{ display: "flex", gap: 12, overflowX: "auto", paddingBottom: 8 }}>
                {(AROMAS[type] || []).map((ar, i) => (
                  <Card key={i} onClick={() => setDetail({ type: type as ProductType, aroma: ar })} style={{ minWidth: 220, flex: "0 0 auto" }}>
                    <CardContent>
                      <div style={{ height: 160, background: "#f3f4f6", borderRadius: 12, display: "grid", placeItems: "center", color: "#9ca3af" }}>Нет фото</div>
                      <div style={{ fontWeight: 700 }}>{ar.name}</div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      <Modal open={!!detail} onClose={() => setDetail(null)} title={detail?.aroma.name}>
        {detail ? <div>{detail.aroma.description || "Описание скоро будет"}</div> : null}
      </Modal>
    </div>
  );
}
