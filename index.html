import React, { useMemo, useState, useEffect } from "react";

/***************************
 * UI kit
 ***************************/
const Card: React.FC<
  React.PropsWithChildren<{
    style?: React.CSSProperties;
    onClick?: () => void;
    hoverDetails?: boolean; // показывать ли затемняющую плашку «Подробнее»
  }>
> = ({ children, style, onClick, hoverDetails = false }) => (
  <div
    onClick={onClick}
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 16,
      padding: 16,
      boxShadow: "0 1px 2px rgba(0,0,0,0.04)",
      background: "#fff",
      position: "relative",
      cursor: onClick ? "pointer" : "default",
      transition: "all 0.3s ease",
      overflow: "hidden",
      ...style,
    }}
    onMouseEnter={(e) => {
      if (!hoverDetails) return;
      const overlay = e.currentTarget.querySelector(".overlay") as HTMLElement | null;
      if (overlay) overlay.style.opacity = "1";
    }}
    onMouseLeave={(e) => {
      if (!hoverDetails) return;
      const overlay = e.currentTarget.querySelector(".overlay") as HTMLElement | null;
      if (overlay) overlay.style.opacity = "0";
    }}
  >
    {children}
    {hoverDetails && (
      <div
        className="overlay"
        style={{
          position: "absolute",
          inset: 0,
          background: "rgba(0,0,0,0.5)",
          color: "#fff",
          display: "grid",
          placeItems: "center",
          fontSize: 16,
          fontWeight: 600,
          opacity: 0,
          transition: "opacity 0.3s ease",
        }}
      >
        Подробнее
      </div>
    )}
  </div>
);

const CardHeader: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ marginBottom: 8 }}>{children}</div>
);
const CardTitle: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <h3
    style={{
      display: "flex",
      alignItems: "center",
      justifyContent: "space-between",
      margin: 0,
      fontSize: 16,
      fontWeight: 600,
    }}
  >
    {children}
  </h3>
);
const CardContent: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <div style={{ display: "grid", gap: 10 }}>{children}</div>
);
const Button: React.FC<
  React.PropsWithChildren<{
    onClick?: () => void;
    disabled?: boolean;
    full?: boolean;
    variant?: "primary" | "ghost";
  }>
> = ({ children, onClick, disabled, full, variant = "primary" }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    style={{
      width: full ? "100%" : undefined,
      padding: "10px 14px",
      borderRadius: 12,
      border: variant === "ghost" ? "1px solid transparent" : "1px solid #111",
      background: disabled ? "#f3f4f6" : variant === "ghost" ? "transparent" : "#111",
      color: disabled ? "#9ca3af" : variant === "ghost" ? "#111" : "#fff",
      cursor: disabled ? "not-allowed" : "pointer",
      fontWeight: 600,
    }}
  >
    {children}
  </button>
);
const Badge: React.FC<React.PropsWithChildren<{}>> = ({ children }) => (
  <span
    style={{
      border: "1px solid #e5e7eb",
      borderRadius: 999,
      padding: "4px 10px",
      fontSize: 12,
      color: "#374151",
      background: "#f9fafb",
    }}
  >
    {children}
  </span>
);

/***************************
 * Modal
 ***************************/
const Modal: React.FC<{ open: boolean; onClose: () => void; title?: string; image?: string }> = ({
  open,
  onClose,
  title,
  image,
  children,
}) => {
  if (!open) return null;
  return (
    <div
      role="dialog"
      aria-modal="true"
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.45)",
        display: "grid",
        placeItems: "center",
        zIndex: 50,
      }}
      onClick={onClose}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        style={{
          width: "min(900px, 92vw)",
          maxHeight: "90vh",
          overflow: "auto",
          background: "#fff",
          borderRadius: 16,
          boxShadow: "0 10px 30px rgba(0,0,0,.2)",
        }}
      >
        <div
          style={{
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            padding: "14px 18px",
            borderBottom: "1px solid #e5e7eb",
          }}
        >
          <h3 style={{ margin: 0, fontSize: 18, fontWeight: 700 }}>{title}</h3>
          <button
            onClick={onClose}
            aria-label="Закрыть"
            style={{
              background: "transparent",
              border: "none",
              fontSize: 22,
              lineHeight: 1,
              cursor: "pointer",
            }}
          >
            ×
          </button>
        </div>
        <div style={{ display: "grid", gap: 16, padding: 18 }}>{children}</div>
      </div>
    </div>
  );
};

/***************************
 * Types
 ***************************/
type ProductType =
  | "свеча"
  | "диффузор"
  | "рефил"
  | "молочко"
  | "мыло"
  | "скраб"
  | "автопарфюм"
  | "лосьон"
  | "бомбочка";
interface Aroma {
  name: string;
  image?: string;
  description?: string;
  pyramid?: { top?: string[]; heart?: string[]; base?: string[] };
}
interface BoxTemplate {
  id: string;
  slots: ProductType[];
  title?: string;
}
interface GiftBox {
  id: string;
  name: string;
  basePrice: number;
  fixedSetPrice?: number;
  image?: string;
  templates: BoxTemplate[];
}

/***************************
 * Data
 ***************************/
const BOXES: GiftBox[] = [
  {
    id: "small",
    name: "Набор малый",
    basePrice: 0,
    fixedSetPrice: 2000,
    image: "179A9273.jpg", // ← добавили фото малого набора (положи рядом с проектом)
    templates: [
      {
        id: "S-fixed",
        title: "Диффузор 1шт + Свеча 1шт + Автопарфюм 1шт",
        slots: ["диффузор", "свеча", "автопарфюм"],
      },
    ],
  },
];

const AROMAS: Record<ProductType, Aroma[]> = {
  диффузор: [
    { name: "Arabian Nights", description: "Загадочный и тёплый аромат востока." },
    { name: "Astoria Lux" },
  ],
  свеча: [{ name: "Mango Kiss" }],
  автопарфюм: [{ name: "Basil & Mint" }],
  рефил: [],
  молочко: [],
  мыло: [],
  лосьон: [],
  скраб: [],
  бомбочка: [],
};

/***************************
 * Helpers
 ***************************/
const currency = (n: number) =>
  new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB" }).format(n);

/***************************
 * Component
 ***************************/
export default function GiftSetBuilder() {
  const [selectedBoxId, setSelectedBoxId] = useState<string | null>(null);
  const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
  const [slotSelections, setSlotSelections] = useState<{ aroma?: Aroma }[]>([]);
  const [detail, setDetail] = useState<{ type: ProductType; aroma: Aroma } | null>(null);

  const selectedBox = useMemo(() => BOXES.find((b) => b.id === selectedBoxId) || null, [selectedBoxId]);
  const selectedTemplate = useMemo(() => selectedBox?.templates.find((t) => t.id === selectedTemplateId) || null, [selectedBox, selectedTemplateId]);

  useEffect(() => {
    if (selectedTemplate) setSlotSelections(selectedTemplate.slots.map(() => ({ aroma: undefined })));
  }, [selectedTemplateId, selectedTemplate]);

  const total = selectedBox?.fixedSetPrice ?? 0;

  return (
    <div style={{ maxWidth: 1040, margin: "0 auto", padding: 16 }}>
      {/* Список наборов */}
      {!selectedBox && (
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(260px,1fr))", gap: 16 }}>
          {BOXES.map((box) => (
            <Card key={box.id} hoverDetails={false}>
              <CardHeader>
                <CardTitle>
                  <span>{box.name}</span>
                  <Badge>{currency(box.fixedSetPrice ?? box.basePrice)}</Badge>
                </CardTitle>
              </CardHeader>

              <CardContent>
                {/* фото набора */}
                {box.image ? (
                  <img
                    src={box.image}
                    alt={box.name}
                    style={{ width: "100%", height: 180, objectFit: "cover", borderRadius: 12, background: "#f3f4f6" }}
                    onError={(e) => ((e.currentTarget.style.display = "none"))}
                  />
                ) : (
                  <div style={{ height: 180, borderRadius: 12, background: "#f3f4f6" }} />
                )}

                {/* описание шаблона */}
                <div style={{ fontSize: 12, color: "#6b7280", whiteSpace: "pre-line" }}>
                  {box.templates[0].title?.split("+").map((line, i) => (
                    <div key={i}>{line.trim()}</div>
                  ))}
                </div>

                {/* кнопка всегда у нижней кромки */}
                <div style={{ marginTop: "auto" }}>
                  <Button
                    full
                    onClick={() => {
                      setSelectedBoxId(box.id);
                      setSelectedTemplateId(box.templates[0].id);
                    }}
                  >
                    Выбрать
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Конструктор */}
      {selectedBox && selectedTemplate && (
        <div style={{ marginTop: 24 }}>
          {Array.from(new Set(selectedTemplate.slots)).map((type) => (
            <div key={type} style={{ marginBottom: 24 }}>
              <h2 style={{ margin: 0, marginBottom: 8 }}>Выберите: {type}</h2>

              <div style={{ display: "flex", gap: 12, overflowX: "auto", paddingBottom: 8 }}>
                {(AROMAS[type] || []).map((ar, i) => (
                  <Card
                    key={i}
                    hoverDetails={true}          // ← затемняющая плашка «Подробнее» только у ароматов
                    onClick={() => setDetail({ type: type as ProductType, aroma: ar })}
                    style={{ minWidth: 220, flex: "0 0 auto" }}
                  >
                    <CardContent>
                      <div
                        style={{
                          height: 160,
                          background: "#f3f4f6",
                          borderRadius: 12,
                          display: "grid",
                          placeItems: "center",
                          color: "#9ca3af",
                        }}
                      >
                        Нет фото
                      </div>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 }}>
                        <div style={{ fontWeight: 700 }}>{ar.name}</div>
                        <Badge>{type}</Badge>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Модалка «Подробнее» */}
      <Modal open={!!detail} onClose={() => setDetail(null)} title={detail?.aroma.name}>
        {detail ? (
          <div style={{ display: "grid", gap: 12 }}>
            <div style={{ fontSize: 14, color: "#374151" }}>
              {detail.aroma.description || "Описание скоро будет"}
            </div>
            <div style={{ border: "1px solid #e5e7eb", borderRadius: 12, padding: 12 }}>
              <h4 style={{ margin: "0 0 8px 0" }}>Пирамида аромата</h4>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 14 }}>
                <tbody>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>Верхние ноты</td>
                    <td style={{ padding: "4px 8px" }}>{detail.aroma.pyramid?.top?.join(", ") || "—"}</td>
                  </tr>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>Сердце</td>
                    <td style={{ padding: "4px 8px" }}>{detail.aroma.pyramid?.heart?.join(", ") || "—"}</td>
                  </tr>
                  <tr>
                    <td style={{ width: 160, color: "#6b7280", padding: "4px 8px" }}>База</td>
                    <td style={{ padding: "4px 8px" }}>{detail.aroma.pyramid?.base?.join(", ") || "—"}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        ) : null}
